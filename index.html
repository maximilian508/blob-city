<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Blob Online 3D</title>
<style>
body { margin:0; overflow:hidden; }
#ui { position:absolute; top:10px; left:10px; color:white; font-family:sans-serif; font-size:20px; }
#shop {
position:absolute; top:60px; left:10px; background:#0008;
padding:10px; border-radius:8px; color:white; display:none;
}
#touch { position:absolute; bottom:20px; left:20px; width:120px; height:120px; border:2px solid white; border-radius:50%; }
</style>
</head>
<body>

<div id="ui">
<div>ID: <span id="userid">Loading...</span></div>
<div>Blobs: <span id="blobcoins">0</span></div>
<button onclick="sellBlob()">SÄLJ</button>
<button onclick="toggleShop()">SHOP</button>
</div>

<div id="shop">
<h3>Skins</h3>
<button onclick="buySkin('guld')">Guld-blob – 200 blobs</button><br><br>
<button onclick="buySkin('grön')">Grön blob – 200 blobs</button><br><br>
<button onclick="buySkin('svart')">Svart blob – 200 blobs</button>
</div>

<div id="touch"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* -------------------------------
SUPABASE – LOGGA IN AUTOMATISKT
--------------------------------*/

// BYT UT DETTA mot ditt projekt senare
const supabase = createClient(
"YOUR_SUPABASE_URL",
"YOUR_SUPABASE_ANON_KEY"
);

let sessionUser = null;
let blobCoins = 0;

async function setupUser() {
let { data: session } = await supabase.auth.getSession();

if (!session.session) {
// skapar anonym användare
let { data } = await supabase.auth.signUp({
email: "user" + Math.random() + "@blob.com",
password: Math.random().toString(36).slice(2)
});
sessionUser = data.user;
} else {
sessionUser = session.session.user;
}

document.getElementById("userid").innerText = sessionUser.id;
loadPlayerData();
}

/* ----- Ladda pengar ----- */
async function loadPlayerData(){
let { data } = await supabase
.from("players")
.select("*")
.eq("id", sessionUser.id)
.single();

if (!data) {
await supabase.from("players").insert({
id: sessionUser.id,
blobs: 0,
skin: "default"
});
blobCoins = 0;
} else {
blobCoins = data.blobs;
}
document.getElementById("blobcoins").innerText = blobCoins;
}

/* ----- Sälj ----- */
async function sellBlob(){
blobCoins += Math.floor(playerSize / 1000);
playerSize = 1;
updateBlobSize();
savePlayerData();
}

/* ----- Spara ----- */
async function savePlayerData(){
await supabase.from("players").update({
blobs: blobCoins,
skin: currentSkin
}).eq("id", sessionUser.id);

document.getElementById("blobcoins").innerText = blobCoins;
}

/* ----- Shop ----- */
let currentSkin = "default";

function toggleShop(){
let s = document.getElementById("shop");
s.style.display = (s.style.display === "none") ? "block" : "none";
}

function buySkin(name){
if (blobCoins < 200) return alert("Du har inte 200 blobs!");
blobCoins -= 200;
currentSkin = name;
blob.material.color.set(
name=="guld" ? 0xffd700 :
name=="grön" ? 0x00ff00 :
name=="svart" ? 0x000000 :
0xff4444
);
savePlayerData();
}

/* -------------------------------
3D-SPELET
--------------------------------*/

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,7,12);

const renderer = new THREE.WebGLRenderer();
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* Blob */
let blobGeo = new THREE.SphereGeometry(1,32,32);
let blobMat = new THREE.MeshStandardMaterial({color:0xff4444});
let blob = new THREE.Mesh(blobGeo, blobMat);
blob.position.y = 1;
scene.add(blob);

let playerSize = 1;

/* Light */
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);

/* Floor */
let floor = new THREE.Mesh(
new THREE.PlaneGeometry(300,300),
new THREE.MeshStandardMaterial({color:0x222222})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* Saker att äta */
let foods = [];
function spawnFood(){
let f = new THREE.Mesh(
new THREE.BoxGeometry(1,1,1),
new THREE.MeshStandardMaterial({color:0xffff00})
);
f.position.set(Math.random()*100-50,0.5,Math.random()*100-50);
scene.add(f);
foods.push(f);
}
for (let i=0;i<50;i++) spawnFood();

/* Monster */
let monsters = [];
function spawnMonster(){
let m = new THREE.Mesh(
new THREE.SphereGeometry(1.5,16,16),
new THREE.MeshStandardMaterial({color:0x00aaff})
);
m.position.set(Math.random()*100-50,1,Math.random()*100-50);
scene.add(m);
monsters.push(m);
}
for (let i=0;i<6;i++) spawnMonster();

/* Rörelse */
let moveX = 0, moveZ = 0;

document.addEventListener("keydown", e=>{
if(e.key=="w") moveZ = -0.2;
if(e.key=="s") moveZ = 0.2;
if(e.key=="a") moveX = -0.2;
if(e.key=="d") moveX = 0.2;
});
document.addEventListener("keyup", e=>{
if(["w","s"].includes(e.key)) moveZ = 0;
if(["a","d"].includes(e.key)) moveX = 0;
});

/* Touch kontroll */
const touchArea = document.getElementById("touch");
touchArea.addEventListener("touchmove", e=>{
let t = e.touches[0];
let rect = touchArea.getBoundingClientRect();
let x = (t.clientX - rect.left) - rect.width/2;
let y = (t.clientY - rect.top) - rect.height/2;
moveX = x/200;
moveZ = y/200;
});

/* Äta */
function updateBlobSize(){
blob.scale.set(playerSize,playerSize,playerSize);
}

function gameLoop(){
requestAnimationFrame(gameLoop);

blob.position.x += moveX;
blob.position.z += moveZ;

camera.lookAt(blob.position);

// Äta mat
foods = foods.filter(f=>{
if(blob.position.distanceTo(f.position) < playerSize+1){
scene.remove(f);
playerSize += 0.1;
updateBlobSize();
return false;
}
return true;
});

// Monster attack
monsters.forEach(m=>{
m.lookAt(blob.position);
m.translateZ(0.05);
if(blob.position.distanceTo(m.position) < 2){
playerSize = Math.max(1, playerSize - 3);
updateBlobSize();
}
});

renderer.render(scene,camera);
}
setupUser();
gameLoop();
</script>
</body>
</html>
